stages:
  dataset_split:
    cmd: python3 src/dataset_split.py
    deps:
    - src/dataset_split.py
    - src/utils/misc.py
    - src/utils/dvc/params.py
    - data/raw/${all.dataset}
    params:
    - dataset_split.split_ratio
    - dataset_split.shuffle
    - all.seed
    - all.dataset
    outs:
    - data/processed/${all.dataset}/train
    - data/processed/${all.dataset}/val
    - data/processed/${all.dataset}/test

# *** ---------------------------------------------

  extract_complexity:
    cmd: python3 src/extract_complexity.py
    deps:
    - src/extract_complexity.py
    - src/utils/data/jpegmse.py
    - src/utils/data/complexityaux.py
    - src/utils/dvc/params.py
    - src/utils/misc.py
    - data/processed/${all.dataset}/train
    - data/processed/${all.dataset}/val
    - data/processed/${all.dataset}/test
    outs:
    - data/processed/${all.dataset}/tabular/complexity.csv
    plots:
    - visualisation/${all.dataset}/complexity_hist.png:
        cache: false

# *** ---------------------------------------------

  cae_hp_tuning:
    cmd: python3 src/cae_hp_tuning.py
    deps:
    - src/cae_hp_tuning.py
    - src/utils/misc.py
    - src/utils/models/kerasaux.py
    - src/utils/models/ktmodels.py
    - src/utils/data/tfdatasets.py
    - data/processed/${all.dataset}/train
    - data/processed/${all.dataset}/val
    params:
    - all.random_crop
    - all.random_flip
    - all.random_rotation
    - all.random_zoom
    - all.random_brightness
    - all.random_contrast
    - all.random_translation_height
    - all.random_translation_width
    - all.input_size
    - all.scale
    - all.grayscale
    - all.dataset
    - all.seed
    - cae_hp_tuning.batch_size
    - cae_hp_tuning.bottleneck_filters
    - cae_hp_tuning.alpha
    - cae_hp_tuning.beta
    - cae_hp_tuning.patience
    - cae_hp_tuning.revive_best
    - cae_hp_tuning.early_stopping
    - cae_hp_tuning.epochs
    - cae_hp_tuning.min_lr
    - cae_hp_tuning.max_trials
    outs:
    - models/${all.dataset}/logs/hp_search/CAE
    - models/${all.dataset}/logs/hp_search/tb
    - models/${all.dataset}/bin/hp_search_best.hdf5
    - models/${all.dataset}/logs/hp_search/hp_search_results.txt
    
# *** ---------------------------------------------

  cae_pretraining:
    cmd: python3 src/cae_pretraining.py
    deps:
    - src/cae_pretraining.py
    - src/utils/models/kerasaux.py
    - src/utils/data/tfdatasets.py
    - src/utils/misc.py
    - data/raw/tiny-imagenet-200
    - models/${all.dataset}/bin/hp_search_best.hdf5
    params:
    - all.random_crop
    - all.random_flip
    - all.random_rotation
    - all.random_zoom
    - all.random_brightness
    - all.random_contrast
    - all.random_translation_height
    - all.random_translation_width
    - all.input_size
    - all.scale
    - all.grayscale
    - all.dataset
    - all.seed
    - cae_pretraining.batch_size
    - cae_pretraining.alpha
    - cae_pretraining.beta
    - cae_pretraining.patience
    - cae_pretraining.revive_best
    - cae_pretraining.early_stopping
    - cae_pretraining.epochs
    - cae_pretraining.min_lr
    - cae_pretraining.learning_rate
    outs:
    - models/${all.dataset}/bin/pretrained_cae.hdf5
    - models/${all.dataset}/logs/pretraining_history.csv

# *** ---------------------------------------------

  cae_training:
    cmd: python3 src/cae_training.py
    deps:
    - src/cae_training.py
    - src/utils/models/kerasaux.py
    - src/utils/data/tfdatasets.py
    - data/processed/train
    - data/processed/val
    - models/casting/bin/pretrained_cae.hdf5
    params:
    - all.random_crop
    - all.random_flip
    - all.random_rotation
    - all.random_zoom
    - all.random_brightness
    - all.random_contrast
    - all.random_translation_height
    - all.random_translation_width
    - cae_training.batch_size
    - cae_training.alpha
    - cae_training.beta
    - cae_training.patience
    - cae_training.revive_best
    - cae_training.early_stopping
    - cae_training.epochs
    - cae_training.min_lr
    - cae_training.learning_rate
    outs:
    - models/casting/bin/trained_cae.hdf5
    - models/casting/logs/training_history.csv

# *** ---------------------------------------------

  reconstruction_visualisation:
    cmd: python3 src/reconstruction_visualisation.py
    deps:
    - src/reconstruction_visualisation.py
    - src/utils/data/tfdatasets.py
    - data/processed/train
    - models/casting/bin/trained_cae.hdf5
    params:
    - all.input_size
    plots:
    - visualisation/reconstruction/casting/reconstructed_images.png:
        cache: false

# *** ---------------------------------------------

  calculate_reconstruction_mse:
    cmd: python3 src/calculate_reconstruction_mse.py
    deps:
    - src/calculate_reconstruction_mse.py
    - models/casting/bin/trained_cae.hdf5
    - src/utils/data/complexityaux.py
    - data/processed/train
    - data/processed/val
    - data/processed/test
    outs:
    - data/processed/tabular/cae_mse.csv
    plots:
    - visualisation/reconstruction/casting/train_ok_front_hist.png:
        cache: false
    - visualisation/reconstruction/casting/val_ok_front_hist.png:
        cache: false
    - visualisation/reconstruction/casting/train_def_front_hist.png:
        cache: false
    - visualisation/reconstruction/casting/val_def_front_hist.png:
        cache: false

# *** ---------------------------------------------

  complexity_vs_caemse:
    cmd: python3 src/complexity_vs_caemse.py
    deps:
    - src/complexity_vs_caemse.py
    - data/processed/tabular/complexity.csv
    - data/processed/tabular/cae_mse.csv
    plots:
    - visualisation/casting_complexity_vs_caemse.html:
        cache: false

# *** ---------------------------------------------

  cae_mse_model:
    cmd: python3 src/cae_mse_model.py
    deps:
    - src/cae_mse_model.py
    - src/utils/models/threshold_search.py
    - data/processed/tabular/cae_mse.csv
    params:
    - cae_mse_model.score_func
    - cae_mse_model.n_iter
    outs:
    - models/casting/params/mse_threshold.txt
    - visualisation/thresholds/casting/mse.html:
        cache: false

# *** ---------------------------------------------

  corrected_model:
    cmd: python3 src/corrected_model.py
    deps:
    - src/corrected_model.py
    - src/utils/models/threshold_search.py
    - data/processed/tabular/cae_mse.csv
    params:
    - corrected_model.score_func
    - corrected_model.n_iter
    outs:
    - models/casting/params/corrected_mse_threshold.txt
    - visualisation/thresholds/casting/corrected_mse.html:
        cache: false


# *** ---------------------------------------------

  evaluate:
    cmd: python3 src/evaluate.py
    deps:
    - src/evaluate.py
    - src/utils/evaluation/classification_metrics.py
    - data/processed/tabular/cae_mse.csv
    - models/casting/params/mse_threshold.txt
    - models/casting/params/corrected_mse_threshold.txt
    metrics:
    - metrics/casting/cae_metrics.json:
        cache: false
    - metrics/casting/corrected_cae_metrics.json:
        cache: false
